<%- include('partials/header', { pageTitle: pageTitle, active: active, extraCss: [] }) %>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
          <li class="breadcrumb-item"><a href="/enterprise-architecture/vulnerabilities">All Vulnerabilities</a></li>
          <% if (vulnerability.project_id) { %>
            <li class="breadcrumb-item"><a href="/enterprise-architecture/projects/<%= vulnerability.project_id %>/vulnerabilities"><%= vulnerability.project_name %></a></li>
          <% } %>
          <li class="breadcrumb-item active" aria-current="page"><%= vulnerability.title %></li>
        </ol>
      </nav>
      <h1 class="mb-0 mt-2"><%= vulnerability.title %></h1>
    </div>
    <div class="btn-group">
      <button type="button" class="btn btn-primary update-vulnerability-status" 
              data-vulnerability-id="<%= vulnerability.id %>" 
              data-current-status="<%= vulnerability.status %>">
        <i class="bi bi-pencil-square me-1"></i>Update Status
      </button>
      <a href="/enterprise-architecture/vulnerabilities" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back to All
      </a>
    </div>
  </div>
  
  <!-- Alert container for notifications -->
  <div id="vulnerabilitiesAlertContainer"></div>
  
  <!-- Vulnerability Details -->
  <div class="row">
    <div class="col-md-8">
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">Vulnerability Details</h5>
        </div>
        <div class="card-body">
          <div class="row mb-3">
            <div class="col-md-3 fw-bold">ID:</div>
            <div class="col-md-9"><%= vulnerability.id %></div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3 fw-bold">Severity:</div>
            <div class="col-md-9">
              <span class="badge bg-<%= vulnerability.severity === 'Critical' ? 'danger' : 
                                       vulnerability.severity === 'High' ? 'warning' : 
                                       vulnerability.severity === 'Medium' ? 'info' : 'secondary' %>">
                <%= vulnerability.severity %>
              </span>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3 fw-bold">Status:</div>
            <div class="col-md-9">
              <span class="badge bg-<%= vulnerability.status === 'Open' ? 'danger' : 
                                       vulnerability.status === 'In Progress' ? 'warning' : 
                                       vulnerability.status === 'Remediated' ? 'success' : 'secondary' %>">
                <%= vulnerability.status %>
              </span>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3 fw-bold">Project:</div>
            <div class="col-md-9">
              <% if (vulnerability.project_id) { %>
                <a href="/enterprise-architecture/projects/<%= vulnerability.project_id %>/vulnerabilities"><%= vulnerability.project_name %></a>
              <% } else { %>
                N/A
              <% } %>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3 fw-bold">Component:</div>
            <div class="col-md-9"><%= vulnerability.component_name || 'N/A' %></div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3 fw-bold">CVSS Score:</div>
            <div class="col-md-9"><%= vulnerability.cvss_score || 'N/A' %></div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3 fw-bold">Discovered:</div>
            <div class="col-md-9"><%= new Date(vulnerability.created_at).toLocaleString() %></div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3 fw-bold">Last Updated:</div>
            <div class="col-md-9"><%= new Date(vulnerability.updated_at).toLocaleString() %></div>
          </div>
          <div class="row mb-3">
            <div class="col-md-3 fw-bold">Description:</div>
            <div class="col-md-9"><%= vulnerability.description || 'No description available' %></div>
          </div>
        </div>
      </div>
      
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">Remediation</h5>
        </div>
        <div class="card-body">
          <% if (vulnerability.remediation_steps) { %>
            <div class="mb-3">
              <h6>Steps to Remediate:</h6>
              <p><%= vulnerability.remediation_steps %></p>
            </div>
          <% } %>
          
          <% if (vulnerability.notes) { %>
            <div class="mb-3">
              <h6>Notes:</h6>
              <p><%= vulnerability.notes %></p>
            </div>
          <% } %>
          
          <% if (!vulnerability.remediation_steps && !vulnerability.notes) { %>
            <p class="text-muted">No remediation information available</p>
          <% } %>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">Status History</h5>
        </div>
        <div class="card-body p-0">
          <% if (history && history.length > 0) { %>
            <div class="list-group list-group-flush">
              <% history.forEach(entry => { %>
                <div class="list-group-item">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-<%= entry.status === 'Open' ? 'danger' : 
                                           entry.status === 'In Progress' ? 'warning' : 
                                           entry.status === 'Remediated' ? 'success' : 'secondary' %>">
                      <%= entry.status %>
                    </span>
                    <small class="text-muted"><%= new Date(entry.created_at).toLocaleString() %></small>
                  </div>
                  <% if (entry.notes) { %>
                    <p class="mb-0 mt-2 small"><%= entry.notes %></p>
                  <% } %>
                  <small class="text-muted">By: <%= entry.updated_by || 'System' %></small>
                </div>
              <% }); %>
            </div>
          <% } else { %>
            <div class="p-3 text-center text-muted">No history available</div>
          <% } %>
        </div>
      </div>
      
      <div class="card mb-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">Technical Details</h5>
        </div>
        <div class="card-body">
          <% if (vulnerability.technical_details) { %>
            <pre class="mb-0"><code><%= vulnerability.technical_details %></code></pre>
          <% } else { %>
            <p class="text-muted">No technical details available</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateStatusModalLabel">Update Vulnerability Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="vulnerabilityStatusForm">
          <input type="hidden" id="vulnerabilityId" value="<%= vulnerability.id %>">
          <div class="mb-3">
            <label for="vulnerabilityStatus" class="form-label">Status</label>
            <select class="form-select" id="vulnerabilityStatus" required>
              <option value="Open" <%= vulnerability.status === 'Open' ? 'selected' : '' %>>Open</option>
              <option value="In Progress" <%= vulnerability.status === 'In Progress' ? 'selected' : '' %>>In Progress</option>
              <option value="Remediated" <%= vulnerability.status === 'Remediated' ? 'selected' : '' %>>Remediated</option>
              <option value="Accepted Risk" <%= vulnerability.status === 'Accepted Risk' ? 'selected' : '' %>>Accepted Risk</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="vulnerabilityNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="vulnerabilityNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary" form="vulnerabilityStatusForm">Update</button>
      </div>
    </div>
  </div>
</div>

<!-- Include Chart.js before including the vulnerabilities script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle status update buttons
    document.querySelectorAll('.update-vulnerability-status').forEach(button => {
      button.addEventListener('click', function() {
        const vulnerabilityId = this.dataset.vulnerabilityId;
        const currentStatus = this.dataset.currentStatus;
        showStatusUpdateModal(vulnerabilityId, currentStatus);
      });
    });
    
    // Handle status update form submission
    const vulnerabilityStatusForm = document.getElementById('vulnerabilityStatusForm');
    if (vulnerabilityStatusForm) {
      vulnerabilityStatusForm.addEventListener('submit', function(e) {
        e.preventDefault();
        updateVulnerabilityStatus();
      });
    }
  });
  
  /**
   * Show status update modal
   * @param {string} vulnerabilityId - The vulnerability ID
   * @param {string} currentStatus - The current status
   */
  function showStatusUpdateModal(vulnerabilityId, currentStatus) {
    const modal = document.getElementById('updateStatusModal');
    const vulnerabilityIdInput = document.getElementById('vulnerabilityId');
    const statusSelect = document.getElementById('vulnerabilityStatus');
    
    vulnerabilityIdInput.value = vulnerabilityId;
    
    // Set current status as selected
    for (let i = 0; i < statusSelect.options.length; i++) {
      if (statusSelect.options[i].value === currentStatus) {
        statusSelect.selectedIndex = i;
        break;
      }
    }
    
    // Show modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
  }
  
  /**
   * Update vulnerability status
   */
  function updateVulnerabilityStatus() {
    const vulnerabilityId = document.getElementById('vulnerabilityId').value;
    const status = document.getElementById('vulnerabilityStatus').value;
    const notes = document.getElementById('vulnerabilityNotes').value;
    
    // Call API to update status
    fetch(`/enterprise-architecture/api/vulnerabilities/${vulnerabilityId}/status`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        status,
        notes
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Hide modal
        const modal = document.getElementById('updateStatusModal');
        const bsModal = bootstrap.Modal.getInstance(modal);
        bsModal.hide();
        
        showAlert('success', 'Vulnerability status updated successfully.');
        
        // Reload the page to show updated status
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        showAlert('danger', `Error updating vulnerability status: ${data.error}`);
      }
    })
    .catch(error => {
      console.error('Error updating vulnerability status:', error);
      showAlert('danger', 'Error updating vulnerability status. Please try again.');
    });
  }
  
  /**
   * Show alert message
   * @param {string} type - Alert type (success, danger, etc.)
   * @param {string} message - Alert message
   */
  function showAlert(type, message) {
    const alertContainer = document.getElementById('vulnerabilitiesAlertContainer');
    const alertHtml = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    `;
    
    alertContainer.innerHTML = alertHtml;
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
      const alert = document.querySelector('.alert');
      if (alert) {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
      }
    }, 5000);
  }
</script>

<%- include('partials/footer') %>
