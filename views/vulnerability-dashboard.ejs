<%- include('partials/header', { pageTitle: 'Vulnerability Dashboard - Threat Model Generator', active: 'vulnerabilities', extraCss: [] }) %>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Vulnerability Dashboard</h1>
    <div class="btn-group">
      <button type="button" class="btn btn-primary" id="refreshVulnBtn">
        <i class="bi bi-arrow-repeat me-1"></i>Refresh Data
      </button>
      <button type="button" class="btn btn-success" id="startScanBtn">
        <i class="bi bi-radar me-1"></i>Start New Scan
      </button>
    </div>
  </div>
  
  <!-- Alert container for notifications -->
  <div id="vulnAlertContainer"></div>
  
  <!-- Project Filter -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row align-items-center">
        <div class="col-md-4">
          <label for="vulnProjectFilter" class="form-label">Filter by Project</label>
          <select class="form-select" id="vulnProjectFilter">
            <option value="">All Projects</option>
            <% projects.forEach(project => { %>
              <option value="<%= project.id %>"><%= project.name %></option>
            <% }); %>
          </select>
        </div>
        <div class="col-md-8">
          <div class="float-end mt-4">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="showOpenOnly" checked>
              <label class="form-check-label" for="showOpenOnly">Open Only</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="showCriticalHigh" checked>
              <label class="form-check-label" for="showCriticalHigh">Critical & High Only</label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Vulnerability Summary -->
  <div class="row mb-4">
    <div class="col-lg-8">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Vulnerability by Severity</h5>
        </div>
        <div class="card-body">
          <canvas id="vulnerabilitySeverityChart" style="height: 300px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Summary</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-6 mb-3">
              <p class="text-muted mb-1">Total</p>
              <h3 id="totalVulnCount"><%= vulnerabilityStats.total || 0 %></h3>
            </div>
            <div class="col-6 mb-3">
              <p class="text-muted mb-1">Open</p>
              <h3 id="openVulnCount" class="text-danger"><%= vulnerabilityStats.open || 0 %></h3>
            </div>
            <div class="col-6 mb-3">
              <p class="text-muted mb-1">Fixed</p>
              <h3 id="fixedVulnCount" class="text-success"><%= vulnerabilityStats.fixed || 0 %></h3>
            </div>
            <div class="col-6 mb-3">
              <p class="text-muted mb-1">In Progress</p>
              <h3 id="inProgressVulnCount" class="text-warning"><%= vulnerabilityStats.in_progress || 0 %></h3>
            </div>
          </div>
          <p class="text-muted mb-1">Remediation Progress</p>
          <div class="progress mb-3" style="height: 25px;">
            <div id="fixedProgressBar" class="progress-bar bg-success" role="progressbar" 
                 style="width: <%= Math.round((vulnerabilityStats.fixed / (vulnerabilityStats.total || 1) * 100)) || 0 %>%;" 
                 aria-valuenow="<%= Math.round((vulnerabilityStats.fixed / (vulnerabilityStats.total || 1) * 100)) || 0 %>" 
                 aria-valuemin="0" aria-valuemax="100">
              <%= Math.round((vulnerabilityStats.fixed / (vulnerabilityStats.total || 1) * 100)) || 0 %>%
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Scan History and Vulnerability Trends -->
  <div class="row mb-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Scan History</h5>
          <a href="/rapid7/scan-history" class="btn btn-sm btn-outline-primary">View All</a>
        </div>
        <div class="card-body">
          <div class="row mb-4">
            <div class="col-6">
              <small class="text-muted d-block">Total Scans</small>
              <h4 id="totalScansCount"><%= scanStats.total_scans || 0 %></h4>
            </div>
            <div class="col-6">
              <small class="text-muted d-block">Last Scan</small>
              <h6 id="lastScanDate" class="text-nowrap"><%= scanStats.last_scan_date || 'Never' %></h6>
            </div>
          </div>
          <canvas id="scanHistoryChart" style="height: 200px;"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
          <h6 class="m-0 font-weight-bold text-primary">Rapid7 Integration</h6>
          <% if (rapid7Connected) { %>
            <button id="syncButton" class="btn btn-sm btn-primary">
              <i class="fas fa-sync-alt"></i> Sync Vulnerabilities
            </button>
          <% } %>
        </div>
        <div class="card-body">
          <div class="row no-gutters align-items-center">
            <div class="col mr-2">
              <div class="text-xs font-weight-bold text-uppercase mb-1">
                Connection Status
              </div>
              <div class="h5 mb-0 font-weight-bold text-gray-800">
                <% if (rapid7Connected) { %>
                  <span class="badge badge-success">Connected</span>
                <% } else { %>
                  <span class="badge badge-danger">Not Connected</span>
                <% } %>
              </div>
              <div class="mt-3">
                <div class="text-xs font-weight-bold text-uppercase mb-1">
                  Last Sync
                </div>
                <div class="h5 mb-0 font-weight-bold text-gray-800" id="lastSyncTime">
                  <%= lastSync ? new Date(lastSync).toLocaleString() : 'Never' %>
                </div>
              </div>
              <div class="mt-3" id="syncStatus" style="display: none;">
                <div class="progress mb-2">
                  <div id="syncProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="syncStatusText" class="text-xs">Starting sync...</p>
              </div>
            </div>
            <div class="col-auto">
              <i class="fas fa-plug fa-2x text-gray-300"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Top Vulnerabilities -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Top Critical &amp; High Vulnerabilities</h5>
      <a href="/enterprise-architecture/vulnerabilities" class="btn btn-sm btn-outline-primary">View All</a>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0" id="topVulnerabilitiesTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Severity</th>
              <th>CVSS</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Populated by JavaScript or server-side data -->
            <% if (topVulnerabilities && topVulnerabilities.length > 0) { %>
              <% topVulnerabilities.forEach(vuln => { %>
                <tr class="<%= vuln.severity === 'Critical' ? 'table-danger' : 'table-warning' %>">
                  <td><%= vuln.name %></td>
                  <td><%= vuln.severity %></td>
                  <td><%= vuln.cvss_score || 'N/A' %></td>
                  <td><span class="badge bg-<%= getStatusBadge(vuln.status) %>"><%= vuln.status %></span></td>
                  <td>
                    <button class="btn btn-sm btn-primary view-vuln-btn" data-vuln-id="<%= vuln.id %>">
                      View
                    </button>
                    <button class="btn btn-sm btn-success link-vuln-btn" data-vuln-id="<%= vuln.id %>" data-vuln-name="<%= vuln.name %>">
                      Link to Threat
                    </button>
                  </td>
                </tr>
              <% }); %>
            <% } else { %>
              <tr>
                <td colspan="5" class="text-center">No vulnerabilities found</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Vulnerability Details Modal -->
<div class="modal fade" id="vulnerabilityDetailsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Vulnerability Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Content populated by JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="updateVulnStatusBtn">Update Status</button>
      </div>
    </div>
  </div>
</div>

<!-- Link Vulnerability Modal -->
<div class="modal fade" id="linkVulnerabilityModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Link Vulnerability to Threat</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="linkVulnerabilityForm">
          <input type="hidden" id="linkVulnId">
          
          <div class="mb-3">
            <label class="form-label">Vulnerability</label>
            <p class="form-control-plaintext" id="linkVulnName"></p>
          </div>
          
          <div class="mb-3">
            <label for="threatSelector" class="form-label">Select Threat</label>
            <select class="form-select" id="threatSelector" required>
              <option value="">Select a threat...</option>
              <!-- Populated by JavaScript -->
            </select>
          </div>
          
          <div class="mb-3">
            <label for="confidenceSlider" class="form-label">Match Confidence: <span id="confidenceValue">80%</span></label>
            <input type="range" class="form-range" id="confidenceSlider" min="10" max="100" value="80" 
                  oninput="document.getElementById('confidenceValue').textContent = this.value + '%'">
          </div>
          
          <div class="mb-3">
            <label for="linkingNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="linkingNotes" rows="3"></textarea>
          </div>
          
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Link Vulnerability</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Scan Config Modal -->
<div class="modal fade" id="scanConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Start New Vulnerability Scan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="startScanForm">
          <div class="mb-3">
            <label for="scanProjectSelect" class="form-label">Select Project</label>
            <select class="form-select" id="scanProjectSelect" required>
              <option value="">Select a project...</option>
              <% projects.forEach(project => { %>
                <option value="<%= project.id %>"><%= project.name %></option>
              <% }); %>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="scanSiteSelect" class="form-label">Select Site in Rapid7</label>
            <select class="form-select" id="scanSiteSelect" required>
              <option value="">Select a site...</option>
              <% if (rapid7Sites && rapid7Sites.length > 0) { %>
                <% rapid7Sites.forEach(site => { %>
                  <option value="<%= site.id %>"><%= site.name %></option>
                <% }); %>
              <% } %>
            </select>
          </div>
          
          <div class="mb-3">
            <label for="scanType" class="form-label">Scan Type</label>
            <select class="form-select" id="scanType">
              <option value="Full">Full Scan</option>
              <option value="Quick">Quick Scan</option>
            </select>
          </div>
          
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="importResults" checked>
            <label class="form-check-label" for="importResults">
              Automatically import results when scan completes
            </label>
          </div>
          
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Start Scan</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Include Chart.js before including the dashboard script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<%- include('partials/footer', { extraJs: ['/js/vulnerabilityDashboard.js'] }) %>

<script>
  
  // Initialize event handlers for the forms
  document.addEventListener('DOMContentLoaded', function() {
    // Start scan form
    const startScanForm = document.getElementById('startScanForm');
    if (startScanForm) {
      startScanForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const projectId = document.getElementById('scanProjectSelect').value;
        const siteId = document.getElementById('scanSiteSelect').value;
        const scanType = document.getElementById('scanType').value;
        const importResults = document.getElementById('importResults').checked;
        
        if (!projectId || !siteId) {
          alert('Please select a project and site');
          return;
        }
        
        // Submit the form via AJAX
        fetch('/api/rapid7/scans', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            project_id: projectId,
            site_id: siteId,
            scan_type: scanType,
            import_results: importResults
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('scanConfigModal'));
            modal.hide();
            
            // Show success message
            showVulnSuccess('Scan started successfully');
            
            // Redirect to scan monitoring page if needed
            if (data.data && data.data.scanHistoryId) {
              window.location.href = `/rapid7/scan-history/${data.data.scanHistoryId}`;
            }
          } else {
            showVulnError(data.error || 'Failed to start scan');
          }
        })
        .catch(error => {
          console.error('Error starting scan:', error);
          showVulnError('Error starting scan');
        });
      });
    }
    
    // Sync now button
    const syncNowBtn = document.getElementById('syncNowBtn');
    if (syncNowBtn) {
      syncNowBtn.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Syncing...';
        
        // Call sync endpoint
        fetch('/api/rapid7/sync', {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showVulnSuccess('Vulnerability sync started. This may take a few minutes.');
          } else {
            showVulnError(data.error || 'Failed to start vulnerability sync');
          }
        })
        .catch(error => {
          console.error('Error syncing vulnerabilities:', error);
          showVulnError('Error syncing vulnerabilities');
        })
        .finally(() => {
          syncNowBtn.disabled = false;
          syncNowBtn.innerHTML = '<i class="bi bi-cloud-download me-1"></i>Sync Vulnerabilities Now';
        });
      });
    }
  });
</script>
